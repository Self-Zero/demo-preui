<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../../../admin/css/pearCommon.css"/>
    <link rel="stylesheet" href="../../../component/layui/css/layui.css"/>
</head>
<body>
<form class="layui-form">
    <div class="mainBox">
        <div class="main-container">
            <div class="layui-form-item">
                <label class="layui-form-label">客户信息:</label>
                <div class="layui-input-inline">
                    <input type="hidden" id="orderId" name="orderId" th:value="${orderInfo.orderId}">
                    <select name="cityId" lay-verify="required" lay-filter="parentCity">
                        <option value="">--请选择--</option>
                        <option th:each="city,userStat:${cityByPatent}" th:value="${city.getCityId()}"
                                th:text="${city.getCityName()}"
                                th:selected="${city.cityId}eq${orderInfo.parentId}"></option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select name="addressId" lay-verify="required" lay-filter="urbanCity" id="urbanCity">
                        <option value="">--请选择--</option>
                        <option th:value="${orderInfo.addressId}" th:text="${orderInfo.cityName}"
                                selected="selected"></option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select name="customerId" lay-verify="required" lay-filter="customers" id="customers">
                        <option value="">--请选择--</option>
                        <option th:value="${orderInfo.customerId}" th:text="${orderInfo.customerName}"
                                selected="selected"></option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select name="phone" lay-filter="customerPhone" id="customerPhone">
                        <option value="">--请选择--</option>
                        <option th:text="${orderInfo.phone}" selected="selected"></option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">订单名称:</label>
                    <div class="layui-input-inline">
                        <input type="text" name="orderName" lay-verify="required" autocomplete="off"
                               placeholder="请输入订单名称" th:value="${orderInfo.orderName}"
                               class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">产品颜色:</label>
                    <div class="layui-input-inline">
                        <input type="text" name="orderColor" lay-verify="required" autocomplete="off"
                               placeholder="请输入产品颜色" th:value="${orderInfo.orderColor}" class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">产品材质:</label>
                    <div class="layui-input-inline">
                        <select name="materialId" lay-verify="required">
                            <option value="">请选择材质</option>
                            <option th:each="material,userStat:${allMaterial}" th:value="${material.materialId}"
                                    th:text="${material.materialName}"
                                    th:selected="${material.materialId}eq${orderInfo.materialId}"></option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">产品类型:</label>
                    <div class="layui-input-inline modeId">
                        <select name="modeId" lay-verify="required" lay-search="">
                            <option value="">请选择类型</option>
                            <option th:each="mode,userStat:${allMode}" th:value="${mode.modeId}"
                                    th:text="${mode.modeName}"
                                    th:selected="${mode.modeId}eq${orderInfo.modeId}"></option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">定金:</label>
                    <div class="layui-input-inline">
                        <input type="tel" name="orderPrice" lay-verify="required|number" autocomplete="off"
                               placeholder="请输入定金" th:value="${orderInfo.orderPrice}" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">全款:</label>
                    <div class="layui-input-inline">
                        <input type="text" name="orderTotal" lay-verify="required|number" autocomplete="off"
                               placeholder="请输入全款" th:value="${orderInfo.orderTotal}" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">数量:</label>
                    <div class="layui-input-inline">
                        <input type="text" name="orderNumber" lay-verify="required|number" autocomplete="off"
                               placeholder="单位（步数,米数,平方数）" th:value="${orderInfo.orderNumber}" class="layui-input">
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">柱型:</label>
                    <div class="layui-input-inline">
                        <select name="battenVersionId">
                            <option value="">请选择柱型</option>
                            <option th:each="version,userStat:${battenVersion}" th:value="${version.battenVersionId}"
                                    th:text="${version.battenVersionName}"
                                    th:selected="${version.battenVersionId}eq${orderInfo.battenVersionId}"></option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">大柱:</label>
                    <div class="layui-input-inline">
                        <select name="battenBigId">
                            <option value="">请选择规格</option>
                            <option th:each="big,userStat:${battenByTypeBig}" th:value="${big.battenTypeId}"
                                    th:text="${big.battenName}"
                                    th:selected="${big.battenTypeId}eq${orderInfo.battenBigId}"></option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">小柱:</label>
                    <div class="layui-input-inline">
                        <select name="battenSmallId">
                            <option value="">请选择规格</option>
                            <option th:each="small,userStat:${battenByTypeSmall}" th:value="${small.battenTypeId}"
                                    th:text="${small.battenName}"
                                    th:selected="${small.battenTypeId}eq${orderInfo.battenSmallId}"></option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-upload">
                        <blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
                            <div class="layui-upload-list" id="img_upload">
                                <span th:if="${orderInfo.demandPic1} != null">
                                    <img class="abc" th:src="${orderInfo.demandPic1}"
                                         style="width: 92px;height: 92px;margin: 0 10px 10px 0;"/>
                                </span>
                                <span th:if="${orderInfo.demandPic2} != null">
                                    <img class="abc" th:src="${orderInfo.demandPic2}"
                                         style="width: 92px;height: 92px;margin: 0 10px 10px 0;"/>
                                </span>
                                <span th:if="${orderInfo.demandPic3} != null">
                                    <img class="abc" th:src="${orderInfo.demandPic3}"
                                         style="width: 92px;height: 92px;margin: 0 10px 10px 0;"/>
                                </span>
                                <span th:if="${orderInfo.demandPic4} != null">
                                    <img class="abc" th:src="${orderInfo.demandPic4}"
                                         style="width: 92px;height: 92px;margin: 0 10px 10px 0;"/>
                                </span>
                                <span th:if="${orderInfo.demandPic5} != null">
                                    <img class="abc" th:src="${orderInfo.demandPic5}"
                                         style="width: 92px;height: 92px;margin: 0 10px 10px 0;"/>
                                </span>
                            </div>
                        </blockquote>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">备注:</label>
                        <div class="layui-input-inline">
                            <input type="text" style="width: 765px;" name="remarks" autocomplete="off"
                                   class="layui-input" th:value="${orderInfo.remarks}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="bottom">
        <div class="button-container">
            <span th:if="${orderInfo.orderState} == 0">
                <button type="submit" id="tijiao" class="layui-btn layui-btn-normal layui-btn-sm" lay-submit=""
                        lay-filter="order-save">
                    <i class="layui-icon layui-icon-ok"></i>
                    编辑
                </button>
                <span th:if="${orderDistribution} == null">
                    <button type="submit" id="distribution" class="layui-btn layui-btn-normal layui-btn-sm"
                            lay-submit=""
                            lay-filter="order-distribution">
                        <i class="layui-icon layui-icon-ok"></i>
                        任务分配
                    </button>
                </span>
                <span th:if="${orderDistribution} != null">
                    <button type="submit" id="wangong" class="layui-btn layui-btn-normal layui-btn-sm" lay-submit="" lay-filter="order-complete">
                        <i class="layui-icon layui-icon-ok"></i>
                        完工
                    </button>
                </span>
            </span>

            <span th:if="${orderInfo.orderState} == 1">
                <span th:if="${orderInfo.sendDate} != null">
                    <span th:if="${orderInfo.reworkDate} == null">
                    <button type="submit" id="fangong" class="layui-btn layui-btn-normal layui-btn-sm" lay-submit=""
                            lay-filter="order-return">
                        <i class="layui-icon layui-icon-ok"></i>
                        返工
                    </button>
                    </span>
                </span>
            </span>
        </div>
    </div>
</form>
<script src="../../../component/layui/layui.js"></script>
<script>

    layui.use(['form', 'jquery'], function () {
        let form = layui.form;
        let $ = layui.jquery;

        $(".abc").click(function(){
            var src = $(this).attr("src");
            var imghtml = "<img src='"+src+"' width='500px' height='500px'></img>"
            layer.open({
                type: 1,
                title: false,
                closeBtn: 0,
                area: '500px',
                skin: 'layui-layer-nobg',
                shadeClose: true,
                content: imghtml
            })
        })

        // 订单修改
        form.on('submit(order-save)', function (data) {
            $.ajax({
                url: '/system/order/update',
                data: JSON.stringify(data.field),
                dataType: 'JSON',
                contentType: 'application/json',
                type: 'POST',
                beforeSend:function(){
                    $("#tijiao").attr("disabled","true");
                },
                success: function (result) {
                    if (result.success) {
                        layer.msg(result.msg, {icon: 1, time: 1000}, function () {
                            parent.layer.close(parent.layer.getFrameIndex(window.name));//关闭当前页
                            parent.layui.table.reload("order-table");
                        });
                    } else {
                        layer.msg(result.msg, {icon: 3, time: 1000},function () {
                            $("#tijiao").removeAttr("disabled");
                        });
                    }
                }
            })
            return false;
        });

        // 订单完工
        form.on('submit(order-complete)', function (obj) {
            $.ajax({
                url: '/state/order/complete/' + obj.field.orderId,
                dataType: 'json',
                contentType: 'application/json',
                type: 'POST',
                beforeSend:function(){
                    $("#wangong").attr("disabled","true");
                },
                success: function (result) {
                    if (result.success) {
                        layer.msg(result.msg, {icon: 1, time: 1000}, function () {
                            parent.layer.close(parent.layer.getFrameIndex(window.name));//关闭当前页
                            parent.layui.table.reload("order-table");
                        });
                    } else {
                        layer.msg(result.msg, {icon: 3, time: 1000},function () {
                            $("#wangong").removeAttr("disabled");
                        });
                    }
                }
            })
            return false;
        });

        let MODULE_PATH = "/view/system/order/";

        // 订单分配
        form.on('submit(order-distribution)', function (obj) {
            layer.open({
                type: 2,
                title: '任务分配',
                data: obj,
                shade: 0.1,
                area: ['500px', '300px'],
                content: MODULE_PATH + 'distribution?orderId=' + obj.field.orderId,
            });
            return false;
        });

        // 订单返工
        form.on('submit(order-return)', function (obj) {
            layer.open({
                type: 2,
                title: '返工',
                data: obj,
                shade: 0.1,
                area: ['500px', '300px'],
                content: MODULE_PATH + 'return?orderId=' + obj.field.orderId,
            });
            return false;
        });

        /*-----------------------------------------------------------------------------------------*/
        //省份下拉选中事件,获取城市下拉选中
        form.render('select');
        form.on('select(parentCity)', function (data) {
            var parentId = data.value;
            // alert(parentId);
            $.ajax({
                type: "post",
                url: "/view/city/cityByParent",
                data: {parentId: parentId},
                dataType: "json",
                success: function (result) {
                    var tmp = '<option value="">--请选择--</option>';
                    //改变省级城市时第三四级下拉框恢复原样
                    $("#customers").html(tmp);
                    $("#customerPhone").html(tmp);
                    for (var i in result) {
                        tmp += '<option value="' + result[i].cityId + '">' + result[i].cityName + '</option>';
                    }
                    $("#urbanCity").html(tmp);
                    form.render();
                },
                error: function () {
                    layer.alert('请求失败，稍后再试', {icon: 5});
                }

            });
        });
        /*-----------------------------------------------------------------------------------------*/
        //城市下拉选中事件，获取用户名称下拉选中
        form.on('select(urbanCity)', function (data) {
            var cityId = data.value;
            $.ajax({
                type: "post",
                url: "/system/customer/customerByUrban",
                data: {cityId: cityId},
                dataType: "json",
                success: function (result) {
                    var tmp = '<option value="">--请选择--</option>';
                    // 改变城市时第四级下拉框恢复原样
                    $("#customerPhone").html(tmp);
                    for (var i in result) {
                        tmp += '<option value="' + result[i].customerId + '">' + result[i].customerName + '</option>';
                    }
                    $("#customers").html(tmp);
                    form.render();
                },
                error: function () {
                    layer.alert('请求失败，稍后再试', {icon: 5});
                }

            });

        });
        /*-----------------------------------------------------------------------------------------*/
        //客户下拉选中事件，获取联系方式下拉选中
        form.on('select(customers)', function (data) {
            var customerId = data.value;
            $.ajax({
                type: "post",
                url: "/system/customer/customerById",
                data: {customerId: customerId},
                dataType: "json",
                success: function (result) {
                    var tmp = '<option value="">--请选择--</option>';
                    for (var i in result) {
                        tmp += '<option value="">' + result[i].phone + '</option>';
                    }
                    $("#customerPhone").html(tmp);
                    form.render();
                },
                error: function () {
                    layer.alert('请求失败，稍后再试', {icon: 5});
                }
            });
        });
    })
</script>
<script>
</script>
</body>
</html>